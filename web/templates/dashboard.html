{% extends "base.html" %}
{% block title %}Dashboard - Hotspot{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div id="stale-banner" class="stale-banner">Data may be stale — status updates have not been received recently.</div>

<div class="dashboard-grid">
    <!-- System Information -->
    <div class="panel">
        <div class="panel-heading">System Information</div>
        <div class="panel-body">
            <table class="kv-table">
                <tr>
                    <td>Hostname</td>
                    <td id="hostname">{{ state.get('hostname', 'unknown') }}</td>
                </tr>
                <tr>
                    <td>Status</td>
                    <td>
                        <span class="status-icon {{ 'up' if state.get('hotspot_running') else 'down' }}" id="hotspot-status">{% if state.get('hotspot_running') %}&#9650; Running{% else %}&#9660; Stopped{% endif %}</span>
                    </td>
                </tr>
                <tr>
                    <td>SSID</td>
                    <td id="ssid">{{ state.get('ssid', 'n/a') }}</td>
                </tr>
                <tr>
                    <td>System Uptime</td>
                    <td id="sys-uptime">{{ format_duration(state.get('sys_uptime_s', 0)) }}</td>
                </tr>
                <tr>
                    <td>Hotspot Uptime</td>
                    <td id="uptime">{{ format_duration(state.get('uptime_s', 0)) }}</td>
                </tr>
                <tr>
                    <td>CPU</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar" id="cpu-bar" style="width: {{ state.get('cpu_pct', 0) }}%"></div>
                            <span class="progress-label" id="cpu-label">{{ state.get('cpu_pct', 0) }}%</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Memory</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar" id="mem-bar" style="width: {{ state.get('mem_pct', 0) }}%"></div>
                            <span class="progress-label" id="mem-label">{{ state.get('mem_pct', 0) }}%</span>
                        </div>
                        <span style="font-size:0.75rem;color:var(--text-secondary)" id="mem-detail">
                            {{ "%.0f"|format(state.get('mem_used_kb', 0) / 1024) }} / {{ "%.0f"|format(state.get('mem_total_kb', 0) / 1024) }} MB
                        </span>
                    </td>
                </tr>
                <tr>
                    <td>Load Average</td>
                    <td id="load-avg">{{ state.get('load_1', 0) }} / {{ state.get('load_5', 0) }} / {{ state.get('load_15', 0) }}</td>
                </tr>
                <tr>
                    <td>Disk</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar" id="disk-bar" style="width: {{ state.get('disk_pct', 0) }}%"></div>
                            <span class="progress-label" id="disk-label">{{ state.get('disk_pct', 0) }}%</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Clients</td>
                    <td><a href="{{ url_for('clients') }}"><span id="client-count">{{ state.get('clients', [])|length }}</span> connected</a></td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Interfaces -->
    <div class="panel panel-table">
        <div class="panel-heading">Interfaces</div>
        <div class="panel-body">
            <table>
                <thead>
                    <tr>
                        <th>Interface</th>
                        <th>Status</th>
                        <th>Address</th>
                        <th>In</th>
                        <th>Out</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>wwan0</td>
                        <td><span class="status-icon {{ 'up' if state.get('wwan0_up') else 'down' }}" id="wwan0-status">{% if state.get('wwan0_up') %}&#9650; Up{% else %}&#9660; Down{% endif %}</span></td>
                        <td id="wwan0-addr">{{ state.get('wwan0_ipv6') or 'n/a' }}</td>
                        <td id="wwan0-rx">{{ format_rate(state.get('wwan0_rx_bps', 0)) }}</td>
                        <td id="wwan0-tx">{{ format_rate(state.get('wwan0_tx_bps', 0)) }}</td>
                    </tr>
                    <tr>
                        <td>clat</td>
                        <td><span class="status-icon {{ 'up' if state.get('clat_up') else 'down' }}" id="clat-status">{% if state.get('clat_up') %}&#9650; Up{% else %}&#9660; Down{% endif %}</span></td>
                        <td id="clat-addr">{{ state.get('clat_ipv4') or 'n/a' }}</td>
                        <td id="clat-rx">{{ format_rate(state.get('clat_rx_bps', 0)) }}</td>
                        <td id="clat-tx">{{ format_rate(state.get('clat_tx_bps', 0)) }}</td>
                    </tr>
                    <tr>
                        <td>wlan0</td>
                        <td><span class="status-icon {{ 'up' if state.get('wlan0_up') else 'down' }}" id="wlan0-status">{% if state.get('wlan0_up') %}&#9650; Up{% else %}&#9660; Down{% endif %}</span></td>
                        <td>192.168.4.1/24</td>
                        <td id="wlan0-rx">{{ format_rate(state.get('wlan0_rx_bps', 0)) }}</td>
                        <td id="wlan0-tx">{{ format_rate(state.get('wlan0_tx_bps', 0)) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <p class="hint"><a href="{{ url_for('status_interfaces') }}">View Details</a></p>
    </div>

    <!-- Services -->
    <div class="panel panel-full panel-table">
        <div class="panel-heading">Services</div>
        <div class="panel-body">
            <table>
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% set svcs = state.get('services', {}) %}
                    <tr>
                        <td>hostapd — WiFi AP</td>
                        <td><span class="status-icon {{ 'up' if svcs.get('hostapd', {}).get('running') else 'down' }}" id="svc-hostapd">{% if svcs.get('hostapd', {}).get('running') %}&#10003; Running{% else %}&#10007; Stopped{% endif %}</span></td>
                        <td><button class="btn-restart" onclick="restartService('hostapd')">&#8635; Restart</button></td>
                    </tr>
                    <tr>
                        <td>dnsmasq — DHCP / DNS</td>
                        <td><span class="status-icon {{ 'up' if svcs.get('dnsmasq', {}).get('running') else 'down' }}" id="svc-dnsmasq">{% if svcs.get('dnsmasq', {}).get('running') %}&#10003; Running{% else %}&#10007; Stopped{% endif %}</span></td>
                        <td>—</td>
                    </tr>
                    <tr>
                        <td>clatd — 464XLAT</td>
                        <td><span class="status-icon {{ 'up' if svcs.get('clatd', {}).get('running') else 'down' }}" id="svc-clatd">{% if svcs.get('clatd', {}).get('running') %}&#10003; Running{% else %}&#10007; Stopped{% endif %}</span></td>
                        <td><button class="btn-restart" onclick="restartService('clatd')">&#8635; Restart</button></td>
                    </tr>
                    <tr>
                        <td>Firewall</td>
                        <td><span class="status-icon {{ 'up' if state.get('firewall_loaded') else 'down' }}" id="fw-status">{% if state.get('firewall_loaded') %}&#10003; Loaded{% else %}&#10007; Not Loaded{% endif %}</span></td>
                        <td>—</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Gateway -->
    <div class="panel panel-full">
        <div class="panel-heading">Gateway</div>
        <div class="panel-body gateway-row">
            IPv6 Gateway: <strong id="gw6-addr">{{ state.get('gw6_addr') or 'n/a' }}</strong>
            via <strong id="gw6-dev">{{ state.get('gw6_dev') or 'n/a' }}</strong>
        </div>
    </div>
</div>

{% if state.get('hotspot_running') %}
<div class="stop-section">
    <button id="stop-btn" class="btn btn-danger" onclick="stopHotspot()">Stop Hotspot</button>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function formatRate(bps) {
    if (bps < 1024) return bps + ' B/s';
    if (bps < 1048576) return (bps / 1024).toFixed(1) + ' KB/s';
    return (bps / 1048576).toFixed(1) + ' MB/s';
}

function formatDuration(s) {
    if (s < 60) return s + 's';
    if (s < 3600) return Math.floor(s/60) + 'm ' + (s%60) + 's';
    return Math.floor(s/3600) + 'h ' + Math.floor((s%3600)/60) + 'm';
}

function setStatus(el, isUp, upText, downText) {
    if (!el) return;
    el.innerHTML = isUp ? '&#9650; ' + upText : '&#9660; ' + downText;
    el.className = 'status-icon ' + (isUp ? 'up' : 'down');
}

function setSvcStatus(el, isUp) {
    if (!el) return;
    el.innerHTML = isUp ? '&#10003; Running' : '&#10007; Stopped';
    el.className = 'status-icon ' + (isUp ? 'up' : 'down');
}

function updateBar(barId, labelId, pct) {
    var bar = document.getElementById(barId);
    var label = document.getElementById(labelId);
    if (!bar) return;
    bar.style.width = pct + '%';
    bar.className = 'progress-bar' + (pct > 90 ? ' danger' : pct > 70 ? ' warn' : '');
    if (label) label.textContent = pct + '%';
}

(function() {
    var es = new EventSource('/api/events');
    es.onmessage = function(e) {
        var d = JSON.parse(e.data);

        /* System info */
        var hn = document.getElementById('hostname');
        if (hn && d.hostname) hn.textContent = d.hostname;

        setStatus(document.getElementById('hotspot-status'), d.hotspot_running, 'Running', 'Stopped');

        var ssid = document.getElementById('ssid');
        if (ssid && d.ssid) ssid.textContent = d.ssid;

        var sysUp = document.getElementById('sys-uptime');
        if (sysUp && d.sys_uptime_s !== undefined) sysUp.textContent = formatDuration(d.sys_uptime_s);

        var uptime = document.getElementById('uptime');
        if (uptime && d.uptime_s !== undefined) uptime.textContent = formatDuration(d.uptime_s);

        updateBar('cpu-bar', 'cpu-label', d.cpu_pct || 0);
        updateBar('mem-bar', 'mem-label', d.mem_pct || 0);
        updateBar('disk-bar', 'disk-label', d.disk_pct || 0);

        var memDetail = document.getElementById('mem-detail');
        if (memDetail) memDetail.textContent = Math.round((d.mem_used_kb || 0) / 1024) + ' / ' + Math.round((d.mem_total_kb || 0) / 1024) + ' MB';

        var loadAvg = document.getElementById('load-avg');
        if (loadAvg) loadAvg.textContent = (d.load_1 || 0) + ' / ' + (d.load_5 || 0) + ' / ' + (d.load_15 || 0);

        document.getElementById('client-count').textContent = d.client_count || 0;

        /* Interfaces */
        setStatus(document.getElementById('wwan0-status'), d.wwan0_up, 'Up', 'Down');
        setStatus(document.getElementById('clat-status'), d.clat_up, 'Up', 'Down');
        setStatus(document.getElementById('wlan0-status'), d.wlan0_up, 'Up', 'Down');

        var wAddr = document.getElementById('wwan0-addr');
        if (wAddr) wAddr.textContent = d.wwan0_ipv6 || 'n/a';
        var cAddr = document.getElementById('clat-addr');
        if (cAddr) cAddr.textContent = d.clat_ipv4 || 'n/a';

        var fields = ['wwan0-rx','wwan0-tx','clat-rx','clat-tx','wlan0-rx','wlan0-tx'];
        var keys = ['wwan0_rx_bps','wwan0_tx_bps','clat_rx_bps','clat_tx_bps','wlan0_rx_bps','wlan0_tx_bps'];
        for (var i = 0; i < fields.length; i++) {
            var el = document.getElementById(fields[i]);
            if (el) el.textContent = formatRate(d[keys[i]] || 0);
        }

        /* Services */
        setSvcStatus(document.getElementById('svc-hostapd'), d.svc_hostapd);
        setSvcStatus(document.getElementById('svc-dnsmasq'), d.svc_dnsmasq);
        setSvcStatus(document.getElementById('svc-clatd'), d.svc_clatd);

        var fwEl = document.getElementById('fw-status');
        if (fwEl) {
            fwEl.innerHTML = d.firewall_loaded ? '&#10003; Loaded' : '&#10007; Not Loaded';
            fwEl.className = 'status-icon ' + (d.firewall_loaded ? 'up' : 'down');
        }

        /* Gateway */
        var gwAddr = document.getElementById('gw6-addr');
        if (gwAddr) gwAddr.textContent = d.gw6_addr || 'n/a';
        var gwDev = document.getElementById('gw6-dev');
        if (gwDev) gwDev.textContent = d.gw6_dev || 'n/a';

        /* Stale banner */
        var stale = document.getElementById('stale-banner');
        if (stale) {
            stale.className = d.data_stale ? 'stale-banner visible' : 'stale-banner';
        }
    };
})();

var csrfToken = document.querySelector('meta[name="csrf-token"]').content;

function restartService(name) {
    if (!confirm('Restart ' + name + '?')) return;
    fetch('/status/services/' + name + '/restart', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(function(r) {
        if (r.status === 401) { window.location.href = '/login'; return; }
        return r.json();
    }).then(function(d) { if (d) alert(d.message || 'Done'); })
    .catch(function(e) { alert('Error: ' + e); });
}

function stopHotspot() {
    if (!confirm('Stop the hotspot? All clients will be disconnected.')) return;
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '/stop';
    var csrf = document.createElement('input');
    csrf.type = 'hidden'; csrf.name = 'csrf_token'; csrf.value = csrfToken;
    form.appendChild(csrf);
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
