#!/bin/bash
# uConsole WiFi Hotspot Toggle Script
# IPv4 clients → clatd (464XLAT CLAT) → IPv6 LTE uplink
# Usage: hotspot start|stop|status

set -euo pipefail

IFACE="wlan0"
WAN_IFACE="wwan0"
HOTSPOT_IP="192.168.4.1/24"
HOSTAPD_CONF="/etc/hostapd/hostapd.conf"
DNSMASQ_CONF="/etc/dnsmasq.d/hotspot.conf"
STATE_FILE="/run/hotspot.state"
PREV_WIFI_FILE="/run/hotspot-prev-wifi"
IPV4_FWD_ORIG="/run/hotspot-ipv4-fwd.orig"
IPV6_FWD_ORIG="/run/hotspot-ipv6-fwd.orig"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${GREEN}[hotspot]${NC} $*"; }
warn() { echo -e "${YELLOW}[hotspot]${NC} $*"; }
err() { echo -e "${RED}[hotspot]${NC} $*" >&2; }

is_running() {
    [ -f "$STATE_FILE" ] || systemctl is-active --quiet hostapd 2>/dev/null
}

save_current_wifi() {
    local ssid
    ssid=$(nmcli -t -f active,ssid dev wifi 2>/dev/null | grep '^yes:' | cut -d: -f2- | sed 's/\\:/:/g' || true)
    if [ -n "$ssid" ]; then
        echo "$ssid" > "$PREV_WIFI_FILE"
        log "Saved current WiFi: $ssid"
    fi
}

get_wan_gw6() {
    local modem_output bearer_path
    modem_output=$(mmcli -m 0 2>/dev/null) || return
    bearer_path=$(echo "$modem_output" | awk '/Bearer/ {for(i=1;i<=NF;i++) if($i ~ /\/Bearer\//) print $i}' | head -1)
    if [ -z "$bearer_path" ]; then
        return
    fi
    local bearer_num
    bearer_num=$(echo "$bearer_path" | awk -F/ '{print $NF}')
    mmcli -b "$bearer_num" 2>/dev/null | grep 'gateway:' | awk '{print $NF}' | head -1
}

wait_for_clat() {
    local i
    for i in $(seq 1 30); do
        if ip link show clat &>/dev/null && ip addr show clat | grep -q 'inet '; then
            return 0
        fi
        sleep 1
    done
    return 1
}

cleanup_on_failure() {
    err "Start failed — rolling back..."
    trap - ERR

    systemctl stop hostapd 2>/dev/null || true

    if [ -f /run/dnsmasq-hotspot.pid ]; then
        pkill -F /run/dnsmasq-hotspot.pid dnsmasq 2>/dev/null || true
        rm -f /run/dnsmasq-hotspot.pid
    fi

    systemctl stop clatd 2>/dev/null || true

    nft delete table ip hotspot_nat 2>/dev/null || true
    nft delete table inet hotspot_fw 2>/dev/null || true

    if [ -f "$IPV4_FWD_ORIG" ]; then
        sysctl -w "net.ipv4.ip_forward=$(cat "$IPV4_FWD_ORIG")" >/dev/null
        rm -f "$IPV4_FWD_ORIG"
    else
        sysctl -w net.ipv4.ip_forward=0 >/dev/null
    fi
    if [ -f "$IPV6_FWD_ORIG" ]; then
        sysctl -w "net.ipv6.conf.all.forwarding=$(cat "$IPV6_FWD_ORIG")" >/dev/null
        rm -f "$IPV6_FWD_ORIG"
    else
        sysctl -w net.ipv6.conf.all.forwarding=0 >/dev/null
    fi

    ip addr flush dev "$IFACE" 2>/dev/null || true
    nmcli device set "$IFACE" managed yes 2>/dev/null || true

    if [ -f "$PREV_WIFI_FILE" ]; then
        local prev_ssid
        prev_ssid=$(cat "$PREV_WIFI_FILE")
        nmcli device wifi connect "$prev_ssid" 2>/dev/null || true
        rm -f "$PREV_WIFI_FILE"
    fi

    rm -f "$STATE_FILE"
    err "Rollback complete"
}

do_start() {
    if is_running; then
        warn "Hotspot is already running"
        exit 0
    fi

    if ! ip link show "$WAN_IFACE" 2>/dev/null | grep -q "LOWER_UP"; then
        err "WAN interface $WAN_IFACE is not up. Is LTE connected?"
        exit 1
    fi

    trap cleanup_on_failure ERR

    log "Starting hotspot..."

    save_current_wifi

    # Disconnect wlan0
    log "Disconnecting wlan0 from WiFi..."
    nmcli device disconnect "$IFACE" 2>/dev/null || true
    sleep 1
    nmcli device set "$IFACE" managed no 2>/dev/null || true

    # Assign static IPv4 to wlan0
    log "Assigning $HOTSPOT_IP to $IFACE..."
    ip addr flush dev "$IFACE"
    ip link set "$IFACE" up
    ip addr add "$HOTSPOT_IP" dev "$IFACE"

    # Save and enable forwarding
    log "Enabling IP forwarding..."
    sysctl -n net.ipv4.ip_forward > "$IPV4_FWD_ORIG"
    sysctl -n net.ipv6.conf.all.forwarding > "$IPV6_FWD_ORIG"
    sysctl -w net.ipv4.ip_forward=1 >/dev/null
    sysctl -w net.ipv6.conf.all.forwarding=1 >/dev/null

    # Set up IPv6 default route via LTE
    local gw6
    gw6=$(get_wan_gw6)
    if [ -n "$gw6" ]; then
        log "Adding IPv6 default route via $gw6..."
        ip -6 route add default via "$gw6" dev "$WAN_IFACE" 2>/dev/null || true
    fi

    # Start clatd (464XLAT CLAT — provides IPv4 via carrier's NAT64)
    log "Starting clatd (464XLAT)..."
    systemctl start clatd
    log "Waiting for clat interface..."
    if wait_for_clat; then
        log "clat interface is up ($(ip -4 addr show clat | awk '/inet / {split($2, a, "/"); print a[1]}'))"
    else
        err "clatd failed to create clat interface after 30s"
        exit 1
    fi

    # Stop system dnsmasq
    systemctl stop dnsmasq 2>/dev/null || true

    # Start hostapd
    log "Starting hostapd..."
    systemctl unmask hostapd 2>/dev/null || true
    systemctl start hostapd

    # Start dnsmasq
    log "Starting dnsmasq (DHCP + DNS + ad blocking)..."
    dnsmasq --conf-file="$DNSMASQ_CONF" --pid-file=/run/dnsmasq-hotspot.pid

    # Firewall + NAT rules
    log "Loading firewall and NAT rules..."

    # IPv4 NAT: clients → clat
    nft -f - <<'NFT'
table ip hotspot_nat {
    chain postrouting {
        type nat hook postrouting priority srcnat;
        oifname "clat" masquerade
    }
    chain forward {
        type filter hook forward priority filter; policy drop;
        ct state established,related accept
        iifname "wlan0" oifname "clat" accept
        counter drop
    }
}
table inet hotspot_fw {
    chain input {
        type filter hook input priority filter; policy drop;
        ct state established,related accept
        iif "lo" accept
        iifname "wlan0" udp dport 67 accept
        iifname "wlan0" udp dport 53 accept
        iifname "wlan0" tcp dport 53 accept
        ip protocol icmp accept
        ip6 nexthdr icmpv6 accept
        iifname "wlan0" tcp dport 22 accept
        counter drop
    }
}
NFT

    trap - ERR
    echo "running" > "$STATE_FILE"

    log "Hotspot is UP!"
    log "SSID: $(grep '^ssid=' "$HOSTAPD_CONF" | cut -d= -f2)"
    log "Clients connect to: 192.168.4.1 (IPv4 DHCP)"
    log "Traffic routed: IPv4 → clat (464XLAT) → IPv6 LTE"
}

do_stop() {
    if ! is_running; then
        warn "Hotspot is not running"
        exit 0
    fi

    log "Stopping hotspot..."

    log "Stopping hostapd..."
    systemctl stop hostapd 2>/dev/null || true

    log "Stopping dnsmasq..."
    if [ -f /run/dnsmasq-hotspot.pid ]; then
        pkill -F /run/dnsmasq-hotspot.pid dnsmasq 2>/dev/null || true
        rm -f /run/dnsmasq-hotspot.pid
    fi

    log "Stopping clatd..."
    systemctl stop clatd 2>/dev/null || true

    log "Removing firewall rules..."
    nft delete table ip hotspot_nat 2>/dev/null || true
    nft delete table inet hotspot_fw 2>/dev/null || true

    log "Restoring IP forwarding..."
    if [ -f "$IPV4_FWD_ORIG" ]; then
        sysctl -w "net.ipv4.ip_forward=$(cat "$IPV4_FWD_ORIG")" >/dev/null
        rm -f "$IPV4_FWD_ORIG"
    else
        sysctl -w net.ipv4.ip_forward=0 >/dev/null
    fi
    if [ -f "$IPV6_FWD_ORIG" ]; then
        sysctl -w "net.ipv6.conf.all.forwarding=$(cat "$IPV6_FWD_ORIG")" >/dev/null
        rm -f "$IPV6_FWD_ORIG"
    else
        sysctl -w net.ipv6.conf.all.forwarding=0 >/dev/null
    fi

    log "Flushing $IFACE..."
    ip addr flush dev "$IFACE"

    nmcli device set "$IFACE" managed yes 2>/dev/null || true

    if [ -f "$PREV_WIFI_FILE" ]; then
        local prev_ssid
        prev_ssid=$(cat "$PREV_WIFI_FILE")
        log "Reconnecting to WiFi: $prev_ssid..."
        nmcli device wifi connect "$prev_ssid" 2>/dev/null || warn "Could not reconnect to $prev_ssid"
        rm -f "$PREV_WIFI_FILE"
    else
        log "No previous WiFi saved, letting NetworkManager auto-connect..."
        sleep 2
    fi

    if systemctl is-enabled dnsmasq &>/dev/null; then
        systemctl start dnsmasq 2>/dev/null || true
    fi

    rm -f "$STATE_FILE"
    log "Hotspot is DOWN"
}

do_status() {
    echo "=== uConsole Hotspot Status ==="
    echo

    if is_running; then
        echo -e "Hotspot: ${GREEN}ACTIVE${NC}"
        echo "SSID: $(grep '^ssid=' "$HOSTAPD_CONF" | cut -d= -f2)"
        echo
    else
        echo -e "Hotspot: ${RED}INACTIVE${NC}"
        echo
        return 0
    fi

    echo "--- Connected Clients ---"
    if command -v hostapd_cli &>/dev/null; then
        local stations
        stations=$(hostapd_cli all_sta 2>/dev/null | grep -c '^[0-9a-f]' || echo "0")
        echo "Associated stations: $stations"
        hostapd_cli all_sta 2>/dev/null | grep -E '^[0-9a-f]|rx_bytes|tx_bytes' || true
    fi
    echo

    echo "--- DHCP Leases ---"
    if [ -f /var/lib/misc/dnsmasq.leases ]; then
        cat /var/lib/misc/dnsmasq.leases
    else
        echo "(no leases file found)"
    fi
    echo

    echo "--- WAN ($WAN_IFACE) ---"
    if ip link show "$WAN_IFACE" 2>/dev/null | grep -q 'LOWER_UP'; then
        echo -e "Status: ${GREEN}UP${NC}"
        ip -6 addr show "$WAN_IFACE" scope global | grep 'inet6' || echo "  (no IPv6)"
    else
        echo -e "Status: ${RED}DOWN${NC}"
    fi
    echo

    echo "--- CLAT (464XLAT) ---"
    if ip link show clat &>/dev/null; then
        echo -e "Status: ${GREEN}UP${NC}"
        ip -4 addr show clat | grep 'inet' || true
    else
        echo -e "Status: ${RED}DOWN${NC}"
    fi
    echo

    echo "--- Firewall ---"
    if nft list table ip hotspot_nat &>/dev/null; then
        echo -e "nftables hotspot tables: ${GREEN}LOADED${NC}"
    else
        echo -e "nftables hotspot tables: ${RED}NOT LOADED${NC}"
    fi
}

case "${1:-}" in
    start)
        [ "$(id -u)" -eq 0 ] || exec sudo "$0" "$@"
        do_start
        ;;
    stop)
        [ "$(id -u)" -eq 0 ] || exec sudo "$0" "$@"
        do_stop
        ;;
    status)
        [ "$(id -u)" -eq 0 ] || exec sudo "$0" "$@"
        do_status
        ;;
    *)
        echo "Usage: hotspot {start|stop|status}"
        exit 1
        ;;
esac
